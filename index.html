<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex">
  <title>NowNow CS Chat Tags Finder</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: 'Helvetica Neue', sans-serif; background: #fff9f3; margin: 0; padding: 20px; display: flex; justify-content: center; }
    .container { background: #ffffff; border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.06); padding: 30px; max-width: 950px; width: 100%; position: relative; box-sizing: border-box; }
    header { display: flex; align-items: center; margin-bottom: 20px; justify-content: center; flex-wrap: wrap; }
    header img { height: 60px; margin-right: 15px; border-radius: 8px; }
    header h1 { font-size: 2rem; margin: 0; color: #2b2b2b; font-weight: 600; }
    .lang-toggle { text-align: center; margin-bottom: 20px; display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap; }
    .lang-toggle button { margin: 5px; padding: 10px 20px; border: 1px solid #ffce00; border-radius: 20px; background: #fff; cursor: pointer; font-weight: bold; transition: transform 0.2s; }
    .lang-toggle button.active { background: linear-gradient(45deg, #ffce00, #ffa500); }
    .lang-toggle button:hover { transform: scale(1.05); }
    .instructions-box { display: flex; justify-content: space-between; gap: 20px; margin-bottom: 20px; }
    .instruction { flex: 1; background: #fff7e6; padding: 16px; border-radius: 12px; border: 1px solid #ffe7b3; font-size: 0.95rem; line-height: 1.5; color: #2b2b2b; }
    .instruction.ar { direction: rtl; text-align: right; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .search-bar { position: relative; width: 100%; margin-bottom: 20px; }
    .search-bar input { width: 100%; padding: 12px; border: 1px solid #ffce00; border-radius: 8px; background-color: #fff7e6; color: #2b2b2b; transition: border-color 0.3s; }
    .search-bar input:focus { outline: none; border-color: #ffa500; box-shadow: 0 0 5px rgba(255, 165, 0, 0.5); }
    .clear-btn { position: absolute; right: 10px; top: 10px; cursor: pointer; border: none; background: none; font-size: 1.2rem; color: #777; opacity: 0.7; transition: opacity 0.3s; }
    .clear-btn:hover { opacity: 1; }
    .group-buttons { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 20px; }
    .group-btn { padding: 8px 14px; border: none; border-radius: 20px; background-color: #ffce00; cursor: pointer; font-size: 0.9rem; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .group-btn.active { background: linear-gradient(45deg, #ffce00, #ffa500); }
    .group-btn:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .all-tags-btn { background: linear-gradient(45deg, #007bff, #0056b3) !important; color: #fff !important; font-weight: bold; }
    .all-tags-btn:hover { background: linear-gradient(45deg, #0069d9, #004085) !important; transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    #tagsContainer {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    #tagsContainer.loaded {
      opacity: 1;
    }
    .tag-card { background: #ffffff; border-radius: 14px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #f4f4f4; transition: transform 0.2s, border-color 0.3s; }
    .tag-card:hover { transform: scale(1.02); border-color: #ff9900; }
    .tag-title { font-weight: 600; color: #ff9900; margin-bottom: 10px; font-size: 1.1em; }
    .copy-btn { margin-top: 12px; cursor: pointer; background: linear-gradient(45deg, #ffce00, #ffa500); color: #000; padding: 8px 14px; border-radius: 8px; border: none; font-size: 0.9rem; transition: background-color 0.3s; }
    .copy-btn.copied { background: linear-gradient(45deg, #88d498, #6ab876); color: #fff; }
    #status { text-align: center; margin-bottom: 8px; font-size: 0.95rem; color: #555; }
    #lastUpdated { text-align: center; font-size: 0.7rem; color: #888; margin-bottom: 8px; }
    #refreshBtn { font-size: 0.7rem; background: #ddd; color: #333; border: none; padding: 4px 8px; border-radius: 8px; cursor: pointer; margin-left: 8px; transition: background-color 0.3s; }
    #refreshBtn:hover { background: #ccc; }

    /* Enhanced Loading Spinner with Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.3s;
    }
    .loading-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #ffce00;
      border-top: 4px solid transparent;
      border-radius: 50%;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Marquee Styles */
    .marquee {
      overflow: hidden;
      background: #ffce00;
      color: #2b2b2b;
      padding: 10px 0;
      margin-bottom: 20px;
      border-radius: 8px;
      position: relative;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: background-color 0.3s;
    }
    .marquee:hover {
      background: #ffc107;
    }
    .marquee-content {
      display: inline-block;
      white-space: nowrap;
      animation: marquee 15s linear infinite;
    }
    .marquee-content span {
      font-size: 0.9rem;
      font-weight: 500;
      padding: 0 20px;
    }
    .marquee-content strong {
      font-weight: bold;
    }
    .marquee:hover .marquee-content {
      animation-play-state: paused;
    }
    @keyframes marquee {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }

    /* Dark Mode Toggle Switch */
    .toggle-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 5px;
    }
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 20px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .slider:hover {
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .slider:before {
      position: absolute;
      content: "🌙";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    input:checked + .slider {
      background-color: #ff9900;
    }
    input:checked + .slider:before {
      content: "☀️";
      transform: translateX(20px);
    }

    /* Dark Mode Styles */
    [data-theme="dark"] {
      background: #1a1a1a;
    }
    [data-theme="dark"] .container {
      background: #2b2b2b;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    }
    [data-theme="dark"] header h1 {
      color: #f0f0f0;
    }
    [data-theme="dark"] .instruction {
      background: #3a3a3a;
      border-color: #555;
      color: #f0f0f0;
    }
    [data-theme="dark"] .tag-card {
      background: #3a3a3a;
      border-color: #444;
    }
    [data-theme="dark"] .tag-title {
      color: #ffcc00;
    }
    [data-theme="dark"] .tag-card div {
      color: #f0f0f0;
    }
    [data-theme="dark"] .marquee-content span {
      color: #f0f0f0;
    }
    [data-theme="dark"] #status {
      color: #cccccc;
    }
    [data-theme="dark"] #lastUpdatedText {
      color: #cccccc;
    }
    [data-theme="dark"] .search-bar input {
      background: #444;
      color: #f0f0f0;
      border-color: #666;
    }
    [data-theme="dark"] .clear-btn {
      color: #cccccc;
    }
    [data-theme="dark"] .group-btn {
      background: #555;
      color: #f0f0f0;
    }
    [data-theme="dark"] .group-btn.active {
      background: linear-gradient(45deg, #ffce00, #ffa500);
    }
    [data-theme="dark"] .marquee {
      background: #444;
    }
    [data-theme="dark"] .marquee:hover {
      background: #555;
    }
    [data-theme="dark"] #refreshBtn {
      background: #555;
      color: #f0f0f0;
    }
    [data-theme="dark"] #refreshBtn:hover {
      background: #666;
    }
    [data-theme="dark"] .loading-overlay {
      background: rgba(26, 26, 26, 0.8);
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>
  <div class="container">
    <header>
      <img src="https://f.nooncdn.com/nownow/Banners_Prod/now-now-web-landing-2x_kJlhLnX0G.png" alt="NowNow Logo">
      <h1>NowNow CS Chat Tags Finder</h1>
    </header>
    <div class="marquee">
      <div class="marquee-content">
        <span id="marqueeText"></span>
      </div>
    </div>
    <div class="instructions-box">
      <div class="instruction">
        Choose your language, then select a group below to filter the available tags.<br>
        You can also search using keywords.<br>
        Find the correct tag, copy and paste it on SalesIQ easily!
      </div>
      <div class="instruction ar">
        اختر اللغة، ثم حدد المجموعة أدناه لتصفية العلامات المتاحة.<br>
        يمكنك أيضًا البحث باستخدام الكلمات الرئيسية.<br>
        ابحث عن العلامة المناسبة، وانسخها والصقها في SalesIQ بسهولة!
      </div>
    </div>
    <div class="lang-toggle">
      <button id="enBtn" class="active" onclick="setLanguage('en')">English</button>
      <button id="arBtn" onclick="setLanguage('ar')">Arabic</button>
      <div class="toggle-wrapper">
        <label class="toggle-switch">
          <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()" aria-label="Toggle dark mode">
          <span class="slider"></span>
        </label>
      </div>
    </div>
    <div class="search-bar">
      <input type="text" placeholder="Search tags or descriptions..." id="searchInput" oninput="filterTags()">
      <button class="clear-btn" onclick="clearSearch()">×</button>
    </div>
    <div id="status"></div>
    <div id="lastUpdated">
      <span id="lastUpdatedText"></span>
      <button id="refreshBtn" onclick="refreshData()">Refresh</button>
    </div>
    <div class="group-buttons" id="groupButtonsContainer" style="display: none;"></div>
    <div id="tagsContainer"></div>

    <script>
      const sheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRxUHKTNNGidfBRrpme1pUvysor1s-jZ27Zk16acjq62djh-ZTTght15r6uzBIlyZdWc55P8Uu8JDma/pub?gid=1849319999&single=true&output=csv';
      const localCacheKey = 'nownow_tag_cache';
      const cacheExpiryKey = 'nownow_tag_cache_expiry';
      const CACHE_DURATION_MS = 7 * 24 * 60 * 60 * 1000; // Cache for 7 days
      let tagData = [];
      let currentLang = 'en';
      let activeGroup = '';
      const translationCache = new Map();

      function setStatus(message) {
        document.getElementById('status').textContent = message;
      }

      function setLastUpdated(timestamp) {
        const date = new Date(timestamp);
        document.getElementById('lastUpdatedText').textContent = `Last updated: ${date.toLocaleString()}`;
      }

      function refreshData() {
        localStorage.removeItem(localCacheKey);
        localStorage.removeItem(cacheExpiryKey);
        loadTagData();
      }

      function updateMarqueeText() {
        const marqueeText = document.getElementById('marqueeText');
        if (currentLang === 'ar') {
          marqueeText.innerHTML = '🚨 من المهم أن تضع علامة على كل محادثة باستخدام <strong>العلامات الصحيحة</strong> 🚨';
        } else {
          marqueeText.innerHTML = '🚨 It\'s important that you tag every chat using the <strong>Correct tags</strong> 🚨';
        }
      }

      function setLanguage(lang) {
        currentLang = lang;
        document.getElementById('enBtn').classList.toggle('active', lang === 'en');
        document.getElementById('arBtn').classList.toggle('active', lang === 'ar');
        updateMarqueeText();
        populateGroupButtons();
        filterTags();
      }

      function toggleDarkMode() {
        const toggle = document.getElementById('darkModeToggle');
        const currentTheme = toggle.checked ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', currentTheme);
        localStorage.setItem('theme', currentTheme);
      }

      async function translateText(text) {
        if (currentLang !== 'ar' || !text) return text;
        if (translationCache.has(text)) return translationCache.get(text);
        try {
          const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=ar&dt=t&q=${encodeURIComponent(text)}`);
          const json = await res.json();
          const translated = json[0][0][0];
          translationCache.set(text, translated);
          return translated;
        } catch {
          return text;
        }
      }

      async function preloadTranslations(data) {
        if (currentLang !== 'ar') return;
        const descs = [...new Set(data.map(d => d.Description))];
        await Promise.all(descs.map(desc => translateText(desc)));
        const groups = [...new Set(data.map(d => d.Group).filter(Boolean))];
        await Promise.all(groups.map(group => translateText(group)));
      }

      async function populateGroupButtons() {
        const container = document.getElementById('groupButtonsContainer');
        container.innerHTML = '';
        container.style.display = 'flex'; // Show buttons after data is loaded
        const categories = [...new Set(tagData.map(row => row.Group).filter(Boolean))];

        const allBtn = document.createElement('button');
        allBtn.textContent = currentLang === 'ar' ? 'كل العلامات' : 'All Tags';
        allBtn.className = 'group-btn all-tags-btn';
        allBtn.onclick = () => { activeGroup = ''; filterTags(); highlightActiveGroup(); };
        container.appendChild(allBtn);

        for (const category of categories) {
          const btn = document.createElement('button');
          btn.className = 'group-btn';
          btn.textContent = await translateText(category);
          btn.setAttribute('data-group', category);
          btn.onclick = () => { activeGroup = category; filterTags(); highlightActiveGroup(); };
          container.appendChild(btn);
        }
        highlightActiveGroup();
      }

      function highlightActiveGroup() {
        document.querySelectorAll('.group-btn').forEach(btn => {
          const btnGroup = btn.getAttribute('data-group') || '';
          btn.classList.toggle('active', btnGroup === activeGroup);
        });
      }

      async function displayTags(tags) {
        const container = document.getElementById('tagsContainer');
        container.innerHTML = '';
        const translated = tags.map(async tag => {
          const translatedDescription = await translateText(tag.Description);
          const escapedTag = tag.Tag.replace(/'/g, "\\'").replace(/"/g, '\\"');
          const card = document.createElement('div');
          card.className = 'tag-card';
          card.innerHTML = `
            <div class="tag-title">${tag.Tag}</div>
            <div>${translatedDescription}</div>
            <button class="copy-btn" onclick="copyToClipboard('${escapedTag}', this)">Copy Tag</button>
          `;
          container.appendChild(card);
        });
        await Promise.all(translated);
        container.classList.add('loaded'); // Fade in tags
      }

      function filterTags() {
        const query = document.getElementById('searchInput').value.toLowerCase();
        const filtered = tagData.filter(tag => {
          const inGroup = !activeGroup || tag.Group === activeGroup;
          const inQuery = tag.Tag.toLowerCase().includes(query) || tag.Description.toLowerCase().includes(query);
          return inGroup && inQuery;
        });
        displayTags(filtered);
        setStatus(`${filtered.length} tag(s) found.`);
      }

      function clearSearch() {
        document.getElementById('searchInput').value = '';
        filterTags();
      }

      function copyToClipboard(tag, buttonElement) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(tag).then(() => {
            buttonElement.classList.add('copied');
            buttonElement.textContent = 'Copied!';
            setTimeout(() => {
              buttonElement.classList.remove('copied');
              buttonElement.textContent = 'Copy Tag';
            }, 1500);
          }).catch(err => {
            console.error('Clipboard API failed:', err);
            fallbackCopyToClipboard(tag, buttonElement);
          });
        } else {
          fallbackCopyToClipboard(tag, buttonElement);
        }
      }

      function fallbackCopyToClipboard(tag, buttonElement) {
        const textarea = document.createElement('textarea');
        textarea.value = tag;
        document.body.appendChild(textarea);
        textarea.select();
        try {
          const successful = document.execCommand('copy');
          if (successful) {
            buttonElement.classList.add('copied');
            buttonElement.textContent = 'Copied!';
            setTimeout(() => {
              buttonElement.classList.remove('copied');
              buttonElement.textContent = 'Copy Tag';
            }, 1500);
          } else {
            setStatus('Failed to copy tag. Please copy manually.');
          }
        } catch (err) {
          console.error('Fallback copy failed:', err);
          setStatus('Failed to copy tag. Please copy manually.');
        } finally {
          document.body.removeChild(textarea);
        }
      }

      async function loadTagData() {
        setStatus('Loading tags...');
        const now = Date.now();
        const expiry = parseInt(localStorage.getItem(cacheExpiryKey), 10);
        const cached = localStorage.getItem(localCacheKey);

        if (cached && expiry && now < expiry) {
          tagData = JSON.parse(cached);
          setLastUpdated(expiry - CACHE_DURATION_MS);
          setStatus('Loaded from cache.');
        } else {
          try {
            const response = await fetch(sheetURL);
            const csvText = await response.text();
            const parsed = Papa.parse(csvText, { header: true });
            tagData = parsed.data.filter(row => row.Tag);
            localStorage.setItem(localCacheKey, JSON.stringify(tagData));
            localStorage.setItem(cacheExpiryKey, now + CACHE_DURATION_MS);
            setLastUpdated(now);
            setStatus('Fresh data loaded.');
          } catch (e) {
            if (cached) {
              tagData = JSON.parse(cached);
              setLastUpdated(expiry - CACHE_DURATION_MS);
              setStatus('Offline. Showing possibly outdated cached data.');
            } else {
              setStatus('Failed to load tag data. Please try again later.');
              document.getElementById('loadingOverlay').classList.add('hidden');
              return;
            }
          }
        }

        await preloadTranslations(tagData);
        await populateGroupButtons();
        await displayTags(tagData);
        setStatus(`${tagData.length} tag(s) loaded.`);
        document.getElementById('loadingOverlay').classList.add('hidden');
        updateMarqueeText();
      }

      // Apply saved theme and load data on page load
      document.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.getElementById('darkModeToggle').checked = savedTheme === 'dark';
        loadTagData();
      });
    </script>
  </div>
</body>
</html>
